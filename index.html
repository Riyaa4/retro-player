<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro Beats</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --cream: #FFF5E4;
      --pink: #FF6B8A;
      --pink-dark: #E74C6F;
      --peach: #FFD4B8;
      --mint: #A8E6CF;
      --lavender: #D4A5FF;
      --sky: #87CEEB;
      --warm-brown: #8B6F5C;
      --dark: #3A2D28;
      --shadow: rgba(58, 45, 40, 0.25);
      --spotify: #1DB954;
      --spotify-dark: #18a34a;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'VT323', monospace;
      background: linear-gradient(135deg, #FFE5EC 0%, #E8D5FF 50%, #D5F0FF 100%);
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,107,138,0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(164,165,255,0.15) 0%, transparent 50%);
      pointer-events: none;
    }

    .stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255,107,138,0.4);
      border-radius: 50%;
      animation: twinkle 3s infinite ease-in-out alternate;
    }

    @keyframes twinkle {
      0% { opacity: 0.2; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1.2); }
    }

    .player-wrapper {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px 0;
    }

    .player-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 18px;
      color: var(--pink);
      text-shadow: 2px 2px 0 var(--peach), 4px 4px 0 rgba(255,107,138,0.2);
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    .player {
      width: 400px;
      background: linear-gradient(145deg, #FFF8F0, #FFE8D6);
      border-radius: 28px;
      padding: 28px 24px 24px;
      box-shadow:
        8px 8px 0 var(--peach),
        12px 12px 0 rgba(255,107,138,0.15),
        0 20px 60px var(--shadow),
        inset 0 2px 0 rgba(255,255,255,0.8);
      border: 3px solid var(--peach);
      position: relative;
      overflow: hidden;
    }

    .player::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--pink), var(--lavender), var(--sky), var(--mint), var(--pink));
      background-size: 200% 100%;
      animation: rainbow 4s linear infinite;
    }

    @keyframes rainbow {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }

    .cassette-window {
      background: linear-gradient(145deg, #2A1F1A, #3D2E26);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      border: 2px solid var(--warm-brown);
      box-shadow: inset 0 4px 12px rgba(0,0,0,0.4);
    }

    .cassette-label {
      text-align: center;
      margin-bottom: 16px;
    }

    .cassette-label .song-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: var(--mint);
      text-shadow: 0 0 10px rgba(168,230,207,0.5);
      display: block;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
    }

    .song-title.scrolling {
      animation: marquee 8s linear infinite;
    }

    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    .cassette-label .artist {
      font-size: 16px;
      color: var(--peach);
      opacity: 0.8;
    }

    .source-badge {
      display: inline-block;
      font-family: 'Press Start 2P', cursive;
      font-size: 7px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 6px;
    }

    .source-badge.spotify {
      background: var(--spotify);
      color: white;
    }

    .source-badge.local {
      background: var(--lavender);
      color: var(--dark);
    }

    .reels {
      display: flex;
      justify-content: center;
      gap: 60px;
      align-items: center;
      position: relative;
    }

    .reel {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid var(--warm-brown);
      position: relative;
      background: radial-gradient(circle, #1A1210 30%, #2A1F1A 70%);
    }

    .reel.spinning {
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .reel::before {
      content: '';
      position: absolute;
      inset: 18px;
      border-radius: 50%;
      border: 2px dashed var(--warm-brown);
    }

    .reel::after {
      content: '';
      position: absolute;
      inset: 26px;
      border-radius: 50%;
      background: var(--warm-brown);
    }

    .reel-hub {
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 1.5px solid rgba(139,111,92,0.4);
    }

    .tape-line {
      position: absolute;
      top: 50%;
      left: calc(50% - 62px);
      width: 124px;
      height: 2px;
      background: var(--warm-brown);
      opacity: 0.4;
    }

    .visualizer {
      display: flex;
      justify-content: center;
      gap: 3px;
      margin-top: 14px;
      height: 24px;
      align-items: flex-end;
    }

    .viz-bar {
      width: 4px;
      background: var(--pink);
      border-radius: 2px;
      transition: height 0.15s ease;
      height: 4px;
    }

    .viz-bar:nth-child(odd) { background: var(--mint); }
    .viz-bar:nth-child(3n) { background: var(--lavender); }
    .viz-bar:nth-child(4n) { background: var(--sky); }

    .progress-section {
      margin-bottom: 16px;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
      color: var(--warm-brown);
      margin-bottom: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--peach);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--pink), var(--lavender));
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      right: -4px;
      top: -2px;
      width: 12px;
      height: 12px;
      background: white;
      border: 2px solid var(--pink);
      border-radius: 50%;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .ctrl-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 22px;
      color: var(--warm-brown);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      background: var(--cream);
      border: 2px solid var(--peach);
    }

    .ctrl-btn:hover {
      transform: scale(1.1);
      border-color: var(--pink);
      color: var(--pink);
    }

    .ctrl-btn:active {
      transform: scale(0.95);
    }

    .play-btn {
      width: 56px;
      height: 56px;
      font-size: 26px;
      background: linear-gradient(145deg, var(--pink), var(--pink-dark));
      color: white;
      border: 3px solid var(--pink-dark);
      box-shadow: 4px 4px 0 var(--peach), 0 4px 15px rgba(255,107,138,0.3);
    }

    .play-btn:hover {
      color: white;
      border-color: var(--pink-dark);
      box-shadow: 2px 2px 0 var(--peach), 0 4px 20px rgba(255,107,138,0.4);
    }

    .volume-section {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 8px;
      margin-bottom: 16px;
      position: relative;
    }

    .volume-section.disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    .volume-hint {
      display: none;
      font-size: 14px;
      color: var(--warm-brown);
      text-align: center;
      margin-bottom: 16px;
      opacity: 0.65;
    }

    .volume-hint.show {
      display: block;
    }

    .volume-icon {
      font-size: 18px;
      color: var(--warm-brown);
      cursor: pointer;
      width: 28px;
      text-align: center;
    }

    .volume-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: var(--peach);
      border-radius: 3px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--pink);
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .playlist {
      background: rgba(255,245,228,0.6);
      border-radius: 12px;
      border: 2px solid var(--peach);
      max-height: 200px;
      overflow-y: auto;
    }

    .playlist::-webkit-scrollbar { width: 6px; }
    .playlist::-webkit-scrollbar-track { background: transparent; }
    .playlist::-webkit-scrollbar-thumb {
      background: var(--peach);
      border-radius: 3px;
    }

    .playlist-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s;
      gap: 10px;
      border-bottom: 1px solid rgba(255,212,184,0.5);
    }

    .playlist-item:last-child { border-bottom: none; }

    .playlist-item:hover {
      background: rgba(255,107,138,0.08);
    }

    .playlist-item.active {
      background: rgba(255,107,138,0.12);
    }

    .playlist-item.active .pl-title {
      color: var(--pink);
    }

    .pl-number {
      font-family: 'Press Start 2P', cursive;
      font-size: 8px;
      color: var(--warm-brown);
      opacity: 0.5;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .pl-info { flex: 1; min-width: 0; }

    .pl-title {
      font-size: 18px;
      color: var(--dark);
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pl-artist {
      font-size: 14px;
      color: var(--warm-brown);
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pl-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      flex-shrink: 0;
    }

    .pl-duration {
      font-size: 14px;
      color: var(--warm-brown);
      opacity: 0.6;
    }

    .pl-badge {
      font-family: 'Press Start 2P', cursive;
      font-size: 6px;
      padding: 2px 5px;
      border-radius: 3px;
      line-height: 1;
    }

    .pl-badge.spotify { background: var(--spotify); color: white; }
    .pl-badge.local { background: var(--lavender); color: var(--dark); }

    .pl-playing {
      display: none;
      gap: 2px;
      align-items: flex-end;
      height: 14px;
    }

    .active .pl-playing { display: flex; }
    .active .pl-number { display: none; }

    .pl-playing span {
      width: 3px;
      background: var(--pink);
      border-radius: 1px;
      animation: eqBar 0.6s ease-in-out infinite alternate;
    }

    .pl-playing span:nth-child(1) { height: 6px; animation-delay: 0s; }
    .pl-playing span:nth-child(2) { height: 10px; animation-delay: 0.15s; }
    .pl-playing span:nth-child(3) { height: 4px; animation-delay: 0.3s; }

    @keyframes eqBar {
      0% { height: 4px; }
      100% { height: 14px; }
    }

    .add-section {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .spotify-input-row {
      display: flex;
      gap: 8px;
    }

    .spotify-input {
      flex: 1;
      font-family: 'VT323', monospace;
      font-size: 17px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 2px solid var(--peach);
      background: var(--cream);
      color: var(--dark);
      outline: none;
      transition: border-color 0.2s;
    }

    .spotify-input:focus {
      border-color: var(--spotify);
    }

    .spotify-input::placeholder {
      color: var(--warm-brown);
      opacity: 0.5;
    }

    .spotify-add-btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 8px;
      background: linear-gradient(145deg, var(--spotify), var(--spotify-dark));
      color: white;
      border: 2px solid var(--spotify-dark);
      border-radius: 10px;
      padding: 8px 14px;
      cursor: pointer;
      box-shadow: 3px 3px 0 rgba(29,185,84,0.3);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .spotify-add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 4px 5px 0 rgba(29,185,84,0.3);
    }

    .spotify-add-btn:active {
      transform: translateY(0);
      box-shadow: 2px 2px 0 rgba(29,185,84,0.3);
    }

    .spotify-add-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .add-songs-btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 8px;
      background: linear-gradient(145deg, var(--lavender), #C490F0);
      color: var(--dark);
      border: 2px solid #C490F0;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      box-shadow: 3px 3px 0 rgba(212,165,255,0.4);
      transition: all 0.2s;
      letter-spacing: 1px;
    }

    .add-songs-btn:hover {
      transform: translateY(-2px);
      box-shadow: 4px 5px 0 rgba(212,165,255,0.4);
    }

    .add-songs-btn:active { transform: translateY(0); box-shadow: 2px 2px 0 rgba(212,165,255,0.4); }

    #file-input { display: none; }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--warm-brown);
    }

    .empty-state .icon { font-size: 40px; margin-bottom: 10px; }
    .empty-state p { font-size: 18px; opacity: 0.7; }
    .empty-state p.small { font-size: 14px; margin-top: 6px; opacity: 0.5; }



    .player-footer {
      text-align: center;
      font-size: 14px;
      color: var(--warm-brown);
      opacity: 0.5;
      margin-top: 4px;
    }

    #spotify-embed-container {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--dark);
      color: var(--cream);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      z-index: 100;
      transition: transform 0.3s ease;
      box-shadow: 0 4px 20px var(--shadow);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast.error { border-left: 4px solid var(--pink); }
    .toast.success { border-left: 4px solid var(--spotify); }
    .toast.info { border-left: 4px solid var(--sky); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-text {
      animation: pulse 1.2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  <div id="spotify-embed-container"></div>

  <div class="player-wrapper">
    <div class="player-title">RETRO BEATS</div>

    <div class="player">

      <div class="cassette-window">
        <div class="cassette-label">
          <span class="song-title" id="display-title">Add songs to play</span>
          <span class="artist" id="display-artist">~</span>
          <span class="source-badge" id="source-badge" style="display:none"></span>
        </div>
        <div class="reels">
          <div class="reel" id="reel-left"><div class="reel-hub"></div></div>
          <div class="tape-line"></div>
          <div class="reel" id="reel-right"><div class="reel-hub"></div></div>
        </div>
        <div class="visualizer" id="visualizer"></div>
      </div>

      <div class="progress-section">
        <div class="time-display">
          <span id="current-time">0:00</span>
          <span id="total-time">0:00</span>
        </div>
        <div class="progress-bar" id="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ctrl-btn" id="shuffle-btn" title="Shuffle">üîÄ</button>
        <button class="ctrl-btn" id="prev-btn" title="Previous">‚èÆ</button>
        <button class="ctrl-btn play-btn" id="play-btn" title="Play">‚ñ∂</button>
        <button class="ctrl-btn" id="next-btn" title="Next">‚è≠</button>
        <button class="ctrl-btn" id="repeat-btn" title="Repeat">üîÅ</button>
      </div>

      <div class="volume-section" id="volume-section">
        <span class="volume-icon" id="volume-icon">üîä</span>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="80">
      </div>
      <div class="volume-hint" id="volume-hint">Use your system volume for Spotify tracks</div>

      <div class="playlist" id="playlist">
        <div class="empty-state" id="empty-state">
          <div class="icon">üìº</div>
          <p>No tapes loaded yet...</p>
          <p class="small">Paste Spotify links or add local files!</p>
        </div>
      </div>

      <div class="add-section">
        <div class="spotify-input-row">
          <input type="text" class="spotify-input" id="spotify-input"
                 placeholder="Paste Spotify track link..."
                 spellcheck="false">
          <button class="spotify-add-btn" id="spotify-add-btn">+ ADD</button>
        </div>
        <div class="btn-row">
          <button class="add-songs-btn" id="add-songs-btn">+ LOCAL FILES</button>
        </div>
        <input type="file" id="file-input" accept="audio/*" multiple>
      </div>
    </div>

    <div class="player-footer">made with ‚ô• and nostalgia</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const audio = new Audio();
    const state = {
      songs: [],
      currentIndex: 0,
      isPlaying: false,
      shuffle: false,
      repeat: 'none',
      shuffleOrder: [],
      spotifyReady: false,
      activeType: null, // 'local' or 'spotify'
    };

    let spotifyIFrameAPI = null;
    let spotifyController = null;
    let spotifyDuration = 0;
    let spotifyPosition = 0;

    const $ = id => document.getElementById(id);
    const displayTitle = $('display-title');
    const displayArtist = $('display-artist');
    const sourceBadge = $('source-badge');
    const playBtn = $('play-btn');
    const prevBtn = $('prev-btn');
    const nextBtn = $('next-btn');
    const shuffleBtn = $('shuffle-btn');
    const repeatBtn = $('repeat-btn');
    const progressBar = $('progress-bar');
    const progressFill = $('progress-fill');
    const currentTimeEl = $('current-time');
    const totalTimeEl = $('total-time');
    const volumeSlider = $('volume-slider');
    const volumeIcon = $('volume-icon');
    const volumeSection = $('volume-section');
    const volumeHint = $('volume-hint');
    const playlistEl = $('playlist');
    const emptyState = $('empty-state');
    const fileInput = $('file-input');
    const addSongsBtn = $('add-songs-btn');
    const spotifyInput = $('spotify-input');
    const spotifyAddBtn = $('spotify-add-btn');
    const reelLeft = $('reel-left');
    const reelRight = $('reel-right');
    const visualizer = $('visualizer');
    const pet = $('pet');
    const toastEl = $('toast');

    let toastTimer = null;

    function showToast(msg, type = 'info') {
      toastEl.textContent = msg;
      toastEl.className = 'toast ' + type + ' show';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 3000);
    }

    // --- Stars ---
    const starsEl = $('stars');
    for (let i = 0; i < 30; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      star.style.width = star.style.height = (2 + Math.random() * 3) + 'px';
      starsEl.appendChild(star);
    }

    // --- Visualizer ---
    for (let i = 0; i < 20; i++) {
      const bar = document.createElement('div');
      bar.className = 'viz-bar';
      visualizer.appendChild(bar);
    }
    const vizBars = visualizer.querySelectorAll('.viz-bar');

    function animateVisualizer() {
      if (!state.isPlaying) {
        vizBars.forEach(b => b.style.height = '4px');
        return;
      }
      vizBars.forEach(bar => {
        bar.style.height = (4 + Math.random() * 20) + 'px';
      });
      requestAnimationFrame(() => setTimeout(animateVisualizer, 120));
    }

    // --- Utilities ---
    function formatTime(s) {
      if (isNaN(s) || s < 0) return '0:00';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }

    function parseName(filename) {
      let name = filename.replace(/\.[^/.]+$/, '');
      const parts = name.split(/\s*[-‚Äì‚Äî]\s*/);
      if (parts.length >= 2) {
        return { title: parts.slice(1).join(' - ').trim(), artist: parts[0].trim() };
      }
      return { title: name.trim(), artist: 'Unknown Artist' };
    }

    function extractSpotifyTrackId(input) {
      input = input.trim();
      // spotify:track:ID
      let m = input.match(/spotify:track:([a-zA-Z0-9]+)/);
      if (m) return m[1];
      // open.spotify.com/track/ID or open.spotify.com/intl-xx/track/ID
      m = input.match(/open\.spotify\.com\/(?:intl-[a-z]{2}\/)?track\/([a-zA-Z0-9]+)/);
      if (m) return m[1];
      return null;
    }

    // --- Spotify IFrame API ---
    function initSpotifyAPI() {
      return new Promise(resolve => {
        if (state.spotifyReady) { resolve(); return; }
        window.onSpotifyIframeApiReady = (IFrameAPI) => {
          spotifyIFrameAPI = IFrameAPI;
          state.spotifyReady = true;
          resolve();
        };
        const s = document.createElement('script');
        s.src = 'https://open.spotify.com/embed/iframe-api/v1';
        document.head.appendChild(s);
      });
    }

    function createSpotifyEmbed(trackId) {
      return new Promise((resolve, reject) => {
        const container = $('spotify-embed-container');
        container.innerHTML = '';
        const el = document.createElement('div');
        el.id = 'spotify-iframe';
        container.appendChild(el);

        const options = {
          uri: 'spotify:track:' + trackId,
          width: 300,
          height: 80,
        };

        spotifyIFrameAPI.createController(el, options, (controller) => {
          spotifyController = controller;

          controller.addListener('playback_update', e => {
            if (currentSong() && currentSong().type === 'spotify') {
              spotifyPosition = e.data.position / 1000;
              spotifyDuration = e.data.duration / 1000;
              const pct = spotifyDuration > 0 ? (spotifyPosition / spotifyDuration) * 100 : 0;
              progressFill.style.width = pct + '%';
              currentTimeEl.textContent = formatTime(spotifyPosition);
              totalTimeEl.textContent = formatTime(spotifyDuration);

              if (e.data.isPaused && state.isPlaying && spotifyPosition > 0 && spotifyDuration > 0) {
                if (spotifyDuration - spotifyPosition < 1.5) {
                  handleTrackEnd();
                } else {
                  state.isPlaying = false;
                  setPlayingUI(false);
                }
              }
              if (!e.data.isPaused && !state.isPlaying) {
                state.isPlaying = true;
                setPlayingUI(true);
              }
            }
          });

          controller.addListener('ready', () => {
            resolve(controller);
          });
        });
      });
    }

    async function loadSpotifyTrack(trackId) {
      if (!spotifyController) {
        await createSpotifyEmbed(trackId);
      } else {
        spotifyController.loadUri('spotify:track:' + trackId);
      }
    }

    // --- Persistence ---
    function savePlaylist() {
      const toSave = state.songs
        .filter(s => s.type === 'spotify')
        .map(s => ({ type: s.type, trackId: s.trackId, title: s.title, artist: s.artist, thumbnail: s.thumbnail }));
      localStorage.setItem('retrobeats_playlist', JSON.stringify(toSave));
    }

    function loadSavedPlaylist() {
      try {
        const data = JSON.parse(localStorage.getItem('retrobeats_playlist'));
        if (data && data.length > 0) {
          data.forEach(s => {
            state.songs.push({
              type: 'spotify',
              trackId: s.trackId,
              title: s.title,
              artist: s.artist,
              thumbnail: s.thumbnail || null,
              duration: null,
              url: null,
            });
          });
          return true;
        }
      } catch {}
      return false;
    }

    // --- Fetch Spotify track metadata via oEmbed ---
    async function fetchSpotifyMeta(trackId) {
      const url = 'https://open.spotify.com/oembed?url=https://open.spotify.com/track/' + trackId;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Not found');
        const data = await res.json();
        let title = data.title || 'Unknown';
        let artist = 'Spotify';
        const parts = title.split(/\s*[-‚Äì‚Äî]\s*/);
        if (parts.length >= 2) {
          artist = parts[0].trim();
          title = parts.slice(1).join(' - ').trim();
        }
        return { title, artist, thumbnail: data.thumbnail_url || null };
      } catch {
        return { title: 'Spotify Track', artist: 'Unknown', thumbnail: null };
      }
    }

    // --- Core Player ---
    function currentSong() {
      return state.songs[state.currentIndex] || null;
    }

    function renderPlaylist() {
      if (state.songs.length === 0) {
        playlistEl.innerHTML = '';
        playlistEl.appendChild(emptyState);
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      const items = state.songs.map((song, i) => {
        const active = i === state.currentIndex ? 'active' : '';
        const badgeClass = song.type === 'spotify' ? 'spotify' : 'local';
        const badgeText = song.type === 'spotify' ? 'SPOTIFY' : 'FILE';
        return `
          <div class="playlist-item ${active}" data-index="${i}">
            <span class="pl-number">${String(i + 1).padStart(2, '0')}</span>
            <div class="pl-playing"><span></span><span></span><span></span></div>
            <div class="pl-info">
              <div class="pl-title">${song.title}</div>
              <div class="pl-artist">${song.artist}</div>
            </div>
            <div class="pl-meta">
              <span class="pl-duration">${song.duration || '--:--'}</span>
              <span class="pl-badge ${badgeClass}">${badgeText}</span>
            </div>
          </div>`;
      }).join('');
      playlistEl.innerHTML = items;

      playlistEl.querySelectorAll('.playlist-item').forEach(item => {
        item.addEventListener('click', () => {
          const idx = parseInt(item.dataset.index);
          loadSong(idx);
          playSong();
        });
      });
    }

    function updateDisplay() {
      if (state.songs.length === 0) {
        displayTitle.textContent = 'Add songs to play';
        displayArtist.textContent = '~';
        sourceBadge.style.display = 'none';
        return;
      }
      const song = currentSong();
      displayTitle.textContent = song.title;
      displayTitle.classList.toggle('scrolling', song.title.length > 28);
      displayArtist.textContent = song.artist;
      sourceBadge.style.display = 'inline-block';
      sourceBadge.className = 'source-badge ' + (song.type === 'spotify' ? 'spotify' : 'local');
      sourceBadge.textContent = song.type === 'spotify' ? 'SPOTIFY' : 'LOCAL';
    }

    function stopCurrent() {
      if (state.activeType === 'local') {
        audio.pause();
        audio.currentTime = 0;
      }
      if (state.activeType === 'spotify' && spotifyController) {
        spotifyController.pause();
      }
      state.isPlaying = false;
      setPlayingUI(false);
    }

    async function loadSong(index) {
      stopCurrent();
      state.currentIndex = index;
      const song = currentSong();
      state.activeType = song.type;
      updateVolumeUI();

      if (song.type === 'local') {
        audio.src = song.url;
      } else if (song.type === 'spotify') {
        if (!state.spotifyReady) await initSpotifyAPI();
        await loadSpotifyTrack(song.trackId);
      }

      progressFill.style.width = '0%';
      currentTimeEl.textContent = '0:00';
      totalTimeEl.textContent = song.duration || '0:00';
      updateDisplay();
      renderPlaylist();
    }

    function updateVolumeUI() {
      const isSpotify = state.activeType === 'spotify';
      volumeSection.classList.toggle('disabled', isSpotify);
      volumeHint.classList.toggle('show', isSpotify);
    }

    function setPlayingUI(playing) {
      playBtn.textContent = playing ? '‚è∏' : '‚ñ∂';
      if (playing) {
        reelLeft.classList.add('spinning');
        reelRight.classList.add('spinning');
        animateVisualizer();
      } else {
        reelLeft.classList.remove('spinning');
        reelRight.classList.remove('spinning');
        vizBars.forEach(b => b.style.height = '4px');
      }
    }

    function playSong() {
      if (state.songs.length === 0) return;
      const song = currentSong();
      if (song.type === 'local') {
        audio.play();
      } else if (song.type === 'spotify' && spotifyController) {
        spotifyController.resume();
      }
      state.isPlaying = true;
      setPlayingUI(true);
    }

    function pauseSong() {
      const song = currentSong();
      if (song && song.type === 'local') {
        audio.pause();
      } else if (song && song.type === 'spotify' && spotifyController) {
        spotifyController.pause();
      }
      state.isPlaying = false;
      setPlayingUI(false);
    }

    function handleTrackEnd() {
      if (state.repeat === 'one') {
        const song = currentSong();
        if (song.type === 'local') {
          audio.currentTime = 0;
          playSong();
        } else if (song.type === 'spotify' && spotifyController) {
          spotifyController.seek(0);
          spotifyController.resume();
        }
      } else if (state.repeat === 'all' || state.currentIndex < state.songs.length - 1) {
        nextSong();
      } else {
        pauseSong();
      }
    }

    function nextSong() {
      if (state.songs.length === 0) return;
      let nextIdx;
      if (state.shuffle) {
        if (state.shuffleOrder.length === 0) generateShuffleOrder();
        nextIdx = state.shuffleOrder.pop();
      } else {
        nextIdx = (state.currentIndex + 1) % state.songs.length;
      }
      loadSong(nextIdx).then(() => { if (state.isPlaying || true) playSong(); });
    }

    function prevSong() {
      if (state.songs.length === 0) return;
      const pos = state.activeType === 'spotify' ? spotifyPosition : audio.currentTime;
      if (pos > 3) {
        if (state.activeType === 'local') { audio.currentTime = 0; }
        else if (spotifyController) { spotifyController.seek(0); }
        return;
      }
      const prevIdx = (state.currentIndex - 1 + state.songs.length) % state.songs.length;
      loadSong(prevIdx).then(() => playSong());
    }

    function generateShuffleOrder() {
      state.shuffleOrder = [...Array(state.songs.length).keys()]
        .filter(i => i !== state.currentIndex)
        .sort(() => Math.random() - 0.5);
    }

    // --- Event Listeners ---
    playBtn.addEventListener('click', () => state.isPlaying ? pauseSong() : playSong());
    nextBtn.addEventListener('click', nextSong);
    prevBtn.addEventListener('click', prevSong);

    shuffleBtn.addEventListener('click', () => {
      state.shuffle = !state.shuffle;
      shuffleBtn.style.opacity = state.shuffle ? '1' : '0.5';
      if (state.shuffle) generateShuffleOrder();
    });
    shuffleBtn.style.opacity = '0.5';

    repeatBtn.addEventListener('click', () => {
      const modes = ['none', 'all', 'one'];
      const idx = (modes.indexOf(state.repeat) + 1) % modes.length;
      state.repeat = modes[idx];
      repeatBtn.textContent = state.repeat === 'one' ? 'üîÇ' : 'üîÅ';
      repeatBtn.style.opacity = state.repeat === 'none' ? '0.5' : '1';
    });
    repeatBtn.style.opacity = '0.5';

    // Local audio events
    audio.addEventListener('timeupdate', () => {
      if (state.activeType !== 'local') return;
      const pct = (audio.currentTime / audio.duration) * 100;
      progressFill.style.width = pct + '%';
      currentTimeEl.textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener('loadedmetadata', () => {
      if (state.activeType !== 'local') return;
      totalTimeEl.textContent = formatTime(audio.duration);
      if (currentSong()) {
        currentSong().duration = formatTime(audio.duration);
        renderPlaylist();
      }
    });

    audio.addEventListener('ended', () => {
      if (state.activeType !== 'local') return;
      handleTrackEnd();
    });

    progressBar.addEventListener('click', e => {
      const rect = progressBar.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      if (state.activeType === 'local') {
        audio.currentTime = pct * audio.duration;
      } else if (state.activeType === 'spotify' && spotifyController) {
        spotifyController.seek(pct * spotifyDuration);
      }
    });

    audio.volume = 0.8;
    volumeSlider.addEventListener('input', () => {
      audio.volume = volumeSlider.value / 100;
      volumeIcon.textContent = audio.volume === 0 ? 'üîá' : audio.volume < 0.5 ? 'üîâ' : 'üîä';
    });

    volumeIcon.addEventListener('click', () => {
      if (audio.volume > 0) {
        audio._prevVol = audio.volume;
        audio.volume = 0;
        volumeSlider.value = 0;
        volumeIcon.textContent = 'üîá';
      } else {
        audio.volume = audio._prevVol || 0.8;
        volumeSlider.value = audio.volume * 100;
        volumeIcon.textContent = audio.volume < 0.5 ? 'üîâ' : 'üîä';
      }
    });

    // --- Add Spotify Track ---
    async function addSpotifyTrack() {
      const input = spotifyInput.value.trim();
      if (!input) return;

      const trackId = extractSpotifyTrackId(input);
      if (!trackId) {
        showToast('Invalid Spotify link! Use a track URL.', 'error');
        return;
      }

      if (state.songs.some(s => s.type === 'spotify' && s.trackId === trackId)) {
        showToast('Track already in playlist!', 'info');
        spotifyInput.value = '';
        return;
      }

      spotifyAddBtn.disabled = true;
      spotifyAddBtn.textContent = '...';

      if (!state.spotifyReady) await initSpotifyAPI();

      const meta = await fetchSpotifyMeta(trackId);
      const wasEmpty = state.songs.length === 0;

      state.songs.push({
        type: 'spotify',
        trackId,
        title: meta.title,
        artist: meta.artist,
        thumbnail: meta.thumbnail,
        duration: null,
        url: null,
      });

      if (wasEmpty) {
        await loadSong(0);
      }

      savePlaylist();
      renderPlaylist();
      spotifyInput.value = '';
      spotifyAddBtn.disabled = false;
      spotifyAddBtn.textContent = '+ ADD';
      showToast('Added: ' + meta.title, 'success');
    }

    spotifyAddBtn.addEventListener('click', addSpotifyTrack);
    spotifyInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addSpotifyTrack();
    });

    // --- Add Local Files ---
    addSongsBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', e => {
      const files = Array.from(e.target.files);
      const wasEmpty = state.songs.length === 0;

      files.forEach(file => {
        const info = parseName(file.name);
        state.songs.push({
          type: 'local',
          title: info.title,
          artist: info.artist,
          url: URL.createObjectURL(file),
          file,
          duration: null,
        });
      });

      if (wasEmpty && state.songs.length > 0) {
        loadSong(0);
      }
      renderPlaylist();
      fileInput.value = '';
      showToast('Added ' + files.length + ' file(s)', 'success');
    });

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT') return;
      if (e.code === 'Space') { e.preventDefault(); state.isPlaying ? pauseSong() : playSong(); }
      if (e.code === 'ArrowRight') nextSong();
      if (e.code === 'ArrowLeft') prevSong();
      if (e.code === 'ArrowUp') { e.preventDefault(); volumeSlider.value = Math.min(100, +volumeSlider.value + 5); volumeSlider.dispatchEvent(new Event('input')); }
      if (e.code === 'ArrowDown') { e.preventDefault(); volumeSlider.value = Math.max(0, +volumeSlider.value - 5); volumeSlider.dispatchEvent(new Event('input')); }
    });

    // --- Default Songs ---
    const defaultSongs = [
      { trackId: '1fDFHXcykq4iw8Gg7s5hG9', title: 'About You', artist: 'The 1975' },
      { trackId: '3qhlB30KknSejmIvZZLjOD', title: 'End of Beginning', artist: 'Djo' },
      { trackId: '3MKhTroJs5GF9H7LqN9fiw', title: 'Devil in Disguise', artist: 'Marino' },
      { trackId: '2NmsngXHeC1GQ9wWrzhOMf', title: 'illicit affairs', artist: 'Taylor Swift' },
      { trackId: '3gixnmepHSsyAuho34rprN', title: 'Khat', artist: 'Navjot Ahuja' },
    ];

    defaultSongs.forEach(s => {
      state.songs.push({
        type: 'spotify',
        trackId: s.trackId,
        title: s.title,
        artist: s.artist,
        thumbnail: null,
        duration: null,
        url: null,
      });
    });

    // --- Init ---
    loadSong(0);
    renderPlaylist();
    updateDisplay();
    initSpotifyAPI();
  </script>
</body>
</html>
